@{
    ViewData["Title"] = "My Subscription Plan";
    var currentSubscription = ViewBag.CurrentSubscription as CRM.Models.PartnerSubscriptionModel;
    var scheduledSubscription = ViewBag.ScheduledSubscription as CRM.Models.PartnerSubscriptionModel;
    var cancelledWithPendingRefund = ViewBag.CancelledWithPendingRefund as List<CRM.Models.PartnerSubscriptionModel>;
    var availablePlans = ViewBag.AvailablePlans as List<CRM.Models.SubscriptionPlanModel>;
    var channelPartnerId = ViewBag.ChannelPartnerId;
    var razorpayKeyId = ViewBag.RazorpayKeyId as string;
}

<style>
    .current-plan-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .current-plan-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
        opacity: 0.3;
    }

    .current-plan-content {
        position: relative;
        z-index: 2;
    }

    /* Ensure white text is visible in both modes */
    .current-plan-section h1,
    .current-plan-section p,
    .current-plan-section strong,
    .current-plan-section .badge,
    .current-plan-section h5,
    .current-plan-section ul li {
        color: white !important;
    }

    /* Days remaining box visibility */
    .current-plan-section .badge,
    .current-plan-section [style*="background: rgba(255, 255, 255, 0.2)"] {
        color: white !important;
    }

    .current-plan-section [style*="background: rgba(255, 255, 255, 0.2)"] strong {
        color: inherit !important;
    }

    /* Trial features box visibility */
    .current-plan-section [style*="background: rgba(255, 255, 255, 0.15)"] {
        color: white !important;
    }

    .current-plan-section [style*="background: rgba(255, 255, 255, 0.15)"] h5,
    .current-plan-section [style*="background: rgba(255, 255, 255, 0.15)"] ul,
    .current-plan-section [style*="background: rgba(255, 255, 255, 0.15)"] li {
        color: white !important;
    }

    /* Dark mode overrides - ensure gradient stays */
    [data-bs-theme="dark"] .current-plan-section,
    .dark-mode .current-plan-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
    }

    [data-bs-theme="dark"] .current-plan-section *,
    .dark-mode .current-plan-section * {
        color: white !important;
    }

    .plan-comparison {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .plan-card {
        background: var(--bs-body-bg, white);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
        border: 2px solid var(--bs-border-color, transparent);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .plan-card.current {
        border-color: #10b981;
        transform: scale(1.02);
    }

    .plan-card.scheduled {
        border-color: #3b82f6;
        transform: scale(1.02);
    }

    .plan-card.recommended {
        border-color: #3b82f6;
        transform: translateY(-10px);
    }

    .plan-card.recommended::before {
        content: 'RECOMMENDED';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: #3b82f6;
        color: white;
        text-align: center;
        padding: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .plan-card.current::before {
        content: 'CURRENT PLAN';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: #10b981;
        color: white;
        text-align: center;
        padding: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .plan-card.scheduled::before {
        content: 'SCHEDULED';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: #3b82f6;
        color: white;
        text-align: center;
        padding: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 1px;
    }

    .plan-card.refund-pending {
        border: 2px solid #f97316;
        background: #fff7ed;
    }

    .plan-card.refund-pending::before {
        content: 'REFUND PENDING';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: #f97316;
        color: white;
        text-align: center;
        padding: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        letter-spacing: 1px;
    }

    /* Light mode text visibility for refund pending cards */
    .plan-card.refund-pending .plan-name,
    .plan-card.refund-pending .price-amount,
    .plan-card.refund-pending .feature-item span,
    .plan-card.refund-pending .feature-category h6 {
        color: #1e293b !important;
    }

    .plan-card.refund-pending .plan-description,
    .plan-card.refund-pending .price-period,
    .plan-card.refund-pending .price-currency {
        color: #475569 !important;
    }

    .plan-card.refund-pending .alert-warning {
        background: #fef3c7 !important;
        color: #92400e !important;
        border-color: #f59e0b !important;
    }

    .plan-card.refund-pending .alert-warning strong {
        color: #78350f !important;
    }

    .plan-card.refund-pending .alert-warning small {
        color: #92400e !important;
    }

    /* Dark mode support for refund-pending cards - AGGRESSIVE */
    [data-bs-theme="dark"] .plan-card.refund-pending,
    .dark-mode .plan-card.refund-pending {
        border: 2px solid #f97316 !important;
        background: linear-gradient(135deg, #7c2d12 0%, #1e293b 100%) !important;
    }

    [data-bs-theme="dark"] .plan-card.refund-pending::before,
    .dark-mode .plan-card.refund-pending::before {
        background: #f97316 !important;
        color: white !important;
    }

    /* Dark mode support for refund alert - AGGRESSIVE */
    [data-bs-theme="dark"] .plan-card.refund-pending .alert-warning,
    .dark-mode .plan-card.refund-pending .alert-warning {
        background: rgba(251, 146, 60, 0.3) !important;
        color: #ffffff !important;
        border-color: #f97316 !important;
    }

    [data-bs-theme="dark"] .plan-card.refund-pending .alert-warning strong,
    .dark-mode .plan-card.refund-pending .alert-warning strong {
        color: #ffffff !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .plan-card.refund-pending .alert-warning small,
    [data-bs-theme="dark"] .plan-card.refund-pending .alert-warning br,
    .dark-mode .plan-card.refund-pending .alert-warning small {
        color: #ffffff !important;
        opacity: 1 !important;
    }

    /* Ensure text is visible in dark mode for refund pending cards - AGGRESSIVE */
    [data-bs-theme="dark"] .plan-card.refund-pending .plan-name,
    [data-bs-theme="dark"] .plan-card.refund-pending .price-amount,
    [data-bs-theme="dark"] .plan-card.refund-pending .feature-item span,
    .dark-mode .plan-card.refund-pending .plan-name,
    .dark-mode .plan-card.refund-pending .price-amount,
    .dark-mode .plan-card.refund-pending .feature-item span {
        color: #ffffff !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .plan-card.refund-pending .plan-description,
    [data-bs-theme="dark"] .plan-card.refund-pending .price-period,
    [data-bs-theme="dark"] .plan-card.refund-pending .price-currency,
    [data-bs-theme="dark"] .plan-card.refund-pending .feature-category,
    .dark-mode .plan-card.refund-pending .plan-description,
    .dark-mode .plan-card.refund-pending .price-period,
    .dark-mode .plan-card.refund-pending .feature-category {
        color: #e2e8f0 !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .plan-card.refund-pending .btn-select-plan,
    .dark-mode .plan-card.refund-pending .btn-select-plan {
        background: #475569 !important;
        color: #ffffff !important;
        opacity: 1 !important;
    }

    [data-bs-theme="dark"] .plan-card.refund-pending .feature-icon,
    .dark-mode .plan-card.refund-pending .feature-icon {
        background: rgba(255, 255, 255, 0.1) !important;
        color: #94a3b8 !important;
    }

    [data-bs-theme="dark"] .plan-card.refund-pending .feature-icon.feature-enabled,
    .dark-mode .plan-card.refund-pending .feature-icon.feature-enabled {
        background: rgba(34, 197, 94, 0.2) !important;
        color: #4ade80 !important;
    }

    .plan-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 50px rgba(0, 0, 0, 0.15);
    }

    .plan-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-top: 1rem;
    }

    .plan-name {
        font-size: 1.75rem;
        font-weight: 800;
        color: var(--bs-body-color, #1e293b);
        margin-bottom: 0.5rem;
    }

    .plan-description {
        color: var(--bs-secondary-color, #64748b);
        font-size: 0.95rem;
        margin-bottom: 1.5rem;
    }

    .plan-pricing {
        text-align: center;
        margin-bottom: 2rem;
    }

    .pricing-toggle {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    .pricing-toggle button {
        padding: 0.5rem 1rem;
        border: 2px solid var(--bs-border-color, #e2e8f0);
        background: var(--bs-body-bg, white);
        color: var(--bs-secondary-color, #64748b);
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .pricing-toggle button:first-child {
        border-radius: 25px 0 0 25px;
        border-right: none;
    }

    .pricing-toggle button:last-child {
        border-radius: 0 25px 25px 0;
        border-left: none;
    }

    .pricing-toggle button.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }

    .price-display {
        margin-bottom: 1rem;
    }

    .price-amount {
        font-size: 3rem;
        font-weight: 900;
        color: var(--bs-body-color, #1e293b);
        line-height: 1;
    }

    .price-currency {
        font-size: 1.5rem;
        color: var(--bs-secondary-color, #64748b);
        vertical-align: top;
    }

    .price-period {
        font-size: 1rem;
        color: var(--bs-secondary-color, #64748b);
        font-weight: 500;
    }

    .price-savings {
        background: #dcfce7;
        color: #166534;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
        margin-top: 0.5rem;
    }
    
    /* Dark mode override for price-savings */
    [data-bs-theme="dark"] .price-savings,
    .dark-mode .price-savings {
        background: #202422 !important;
        color: #ffffff !important;
    }

    .plan-features {
        margin-bottom: 2rem;
    }

    .feature-category {
        margin-bottom: 1.5rem;
    }

    .feature-category h6 {
        font-size: 0.875rem;
        font-weight: 700;
        color: var(--bs-body-color, #374151);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--bs-border-color, #f1f5f9);
    }

    .feature-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .feature-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .feature-enabled {
        background: #dcfce7;
        color: #166534;
    }

    .feature-disabled {
        background: #fee2e2;
        color: #991b1b;
    }

    .feature-limited {
        background: #fef3c7;
        color: #92400e;
    }
    
    /* Aggressive dark mode override for feature-enabled */
    [data-bs-theme="dark"] .feature-enabled,
    .dark-mode .feature-enabled,
    [data-bs-theme="dark"] .feature-item .feature-enabled,
    .dark-mode .feature-item .feature-enabled,
    [data-bs-theme="dark"] .plan-card .feature-enabled,
    .dark-mode .plan-card .feature-enabled,
    [data-bs-theme="dark"] .feature-icon.feature-enabled,
    .dark-mode .feature-icon.feature-enabled,
    body[data-bs-theme="dark"] .feature-enabled,
    body.dark-mode .feature-enabled {
        background: #181817 !important;
        color: #e4dcd7 !important;
        border: none !important;
    }
    
    /* Aggressive dark mode override for feature-limited */
    [data-bs-theme="dark"] .feature-limited,
    .dark-mode .feature-limited,
    [data-bs-theme="dark"] .feature-item .feature-limited,
    .dark-mode .feature-item .feature-limited,
    [data-bs-theme="dark"] .plan-card .feature-limited,
    .dark-mode .plan-card .feature-limited,
    [data-bs-theme="dark"] .feature-icon.feature-limited,
    .dark-mode .feature-icon.feature-limited,
    body[data-bs-theme="dark"] .feature-limited,
    body.dark-mode .feature-limited {
        background: #181817 !important;
        color: #e4dcd7 !important;
        border: none !important;
    }
    
    /* Aggressive dark mode override for feature-disabled */
    [data-bs-theme="dark"] .feature-disabled,
    .dark-mode .feature-disabled,
    [data-bs-theme="dark"] .feature-item .feature-disabled,
    .dark-mode .feature-item .feature-disabled,
    [data-bs-theme="dark"] .plan-card .feature-disabled,
    .dark-mode .plan-card .feature-disabled,
    [data-bs-theme="dark"] .feature-icon.feature-disabled,
    .dark-mode .feature-icon.feature-disabled,
    body[data-bs-theme="dark"] .feature-disabled,
    body.dark-mode .feature-disabled {
        background: #181817 !important;
        color: #e4dcd7 !important;
        border: none !important;
    }

    .plan-action {
        text-align: center;
    }

    .btn-select-plan {
        width: 100%;
        padding: 1rem 2rem;
        border-radius: 50px;
        font-weight: 700;
        font-size: 1rem;
        border: none;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-current {
        background: #10b981;
        color: white;
        cursor: default;
    }

    .btn-upgrade {
        background: #3b82f6;
        color: white;
    }

    .btn-upgrade:hover {
        background: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
    }

    .btn-downgrade {
        background: #f59e0b;
        color: white;
    }

    .btn-downgrade:hover {
        background: #d97706;
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
    }

    .usage-stats {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 16px;
        padding: 1rem;
        margin-top: 0;
    }

    .usage-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .usage-item:last-child {
        margin-bottom: 0;
    }

    .usage-label {
        font-weight: 600;
        opacity: 0.9;
        font-size: 0.9rem;
    }

    .usage-value {
        font-weight: 700;
        font-size: 1rem;
    }

    .usage-bar {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.25rem;
    }

    .usage-fill {
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    @@media (max-width: 768px) {
        .plan-comparison {
            grid-template-columns: 1fr;
        }
        
        .current-plan-section {
            padding: 2rem 1.5rem;
        }
        
        .plan-card {
            padding: 1.5rem;
        }
        
        .price-amount {
            font-size: 2.5rem;
        }
        
        #paymentModal .modal-dialog,
        .modal#paymentModal .modal-dialog,
        [data-bs-theme="dark"] #paymentModal .modal-dialog,
        .dark-mode #paymentModal .modal-dialog,
        body #paymentModal .modal-dialog {
            max-width: 95% !important;
            width: 95% !important;
            margin: 1rem !important;
        }
    }
    
    /* Aggressive payment modal width override */
    #paymentModal .modal-dialog,
    .modal#paymentModal .modal-dialog,
    [data-bs-theme="dark"] #paymentModal .modal-dialog,
    .dark-mode #paymentModal .modal-dialog,
    body #paymentModal .modal-dialog {
        max-width: 50% !important;
        width: 50% !important;
    }
    
    @@media (max-width: 768px) {
        #paymentModal .modal-dialog,
        .modal#paymentModal .modal-dialog,
        [data-bs-theme="dark"] #paymentModal .modal-dialog,
        .dark-mode #paymentModal .modal-dialog,
        body #paymentModal .modal-dialog {
            max-width: 95% !important;
            width: 95% !important;
            margin: 1rem !important;
        }
    }
    
    /* Dark mode icon fixes */
    [data-bs-theme="dark"] .feature-icon i,
    [data-bs-theme="dark"] .fa-solid,
    [data-bs-theme="dark"] .fa-brands {
        color: inherit !important;
    }
    
    .dark-mode .feature-icon i,
    .dark-mode .fa-solid,
    .dark-mode .fa-brands {
        color: inherit !important;
    }
</style>

@Html.AntiForgeryToken()

<div class="content">
    <!-- Breadcrumb -->
    <nav class="mb-3" aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="/Home/Index">Home</a></li>
            <li class="breadcrumb-item active">My Subscription Plan</li>
        </ol>
    </nav>

    <!-- Current Plan Section -->
    <div class="current-plan-section">
        <div class="current-plan-content">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-2">
                            @if (currentSubscription?.BillingCycle == "Trial")
                            {
                                <i class="fa-solid fa-gift" style="font-size: 2.5rem; opacity: 0.9;"></i>
                            }
                            else
                            {
                                <i class="fa-solid fa-crown" style="font-size: 2.5rem; opacity: 0.9;"></i>
                            }
                        </div>
                        <div>
                            @if (currentSubscription?.Plan != null)
                            {
                                @if (currentSubscription.BillingCycle == "Trial")
                                {
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <h1 class="mb-0" style="font-size: 2rem; font-weight: 700; color: white;">@currentSubscription.Plan.PlanName</h1>
                                        <span class="badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); font-size: 0.75rem; padding: 0.35rem 0.75rem; border-radius: 20px; color: white;">
                                            <i class="fa-solid fa-sparkles me-1"></i>FREE TRIAL
                                        </span>
                                    </div>
                                    var daysRemaining = (currentSubscription.EndDate - DateTime.Now).Days;
                                    var trialColor = daysRemaining <= 2 ? "#fff" : (daysRemaining <= 5 ? "#fff" : "#fff");
                                    <p class="mb-1" style="font-size: 0.95rem; opacity: 0.95; color: white;">
                                        <i class="fa-solid fa-calendar-days me-1"></i>Trial expires on <strong style="color: white;">@currentSubscription.EndDate.ToString("MMMM dd, yyyy")</strong>
                                    </p>
                                    <div class="mt-1" style="background: rgba(255, 255, 255, 0.25); padding: 0.5rem 0.75rem; border-radius: 8px; display: inline-block;">
                                        <i class="fa-solid fa-hourglass-half me-1" style="color: #fbbf24;"></i>
                                        <strong style="font-size: 1rem; color: white;">@daysRemaining days remaining</strong> <span style="color: white;">in your trial</span>
                                    </div>
                                }
                                else
                                {
                                    <h1 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">@currentSubscription.Plan.PlanName</h1>
                                    <p class="mb-0" style="font-size: 1.1rem; opacity: 0.9;">
                                        Active until @currentSubscription.EndDate.ToString("MMMM dd, yyyy") • @currentSubscription.BillingCycle billing
                                    </p>
                                }
                            }
                            else
                            {
                                <h1 class="mb-0" style="font-size: 2.5rem; font-weight: 700;">No Active Plan</h1>
                                <p class="mb-0" style="font-size: 1.1rem; opacity: 0.9;">Choose a subscription plan to get started</p>
                            }
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    @if (currentSubscription?.Plan != null)
                    {
                        @if (currentSubscription.BillingCycle == "Trial")
                        {
                            <!-- Trial specific info -->
                            <div style="background: rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 10px; border: 2px solid rgba(255, 255, 255, 0.4);">
                                <div class="text-center mb-2">
                                    <i class="fa-solid fa-rocket" style="font-size: 2rem; opacity: 0.9; color: white;"></i>
                                </div>
                                <h5 class="text-center mb-2" style="font-weight: 700; font-size: 1rem; color: white;">Explore All Features</h5>
                                <ul class="list-unstyled mb-0" style="font-size: 0.85rem; color: white;">
                                    <li class="mb-1" style="color: white;"><i class="fa-solid fa-check-circle me-1" style="color: #10b981;"></i>Full access to @currentSubscription.Plan.PlanName</li>
                                    <li class="mb-1" style="color: white;"><i class="fa-solid fa-check-circle me-1" style="color: #10b981;"></i>No payment required</li>
                                    <li class="mb-1" style="color: white;"><i class="fa-solid fa-check-circle me-1" style="color: #10b981;"></i>@(currentSubscription.Plan.MaxAgents == -1 ? "Unlimited" : currentSubscription.Plan.MaxAgents.ToString()) agents</li>
                                    <li class="mb-0" style="color: white;"><i class="fa-solid fa-check-circle me-1" style="color: #10b981;"></i>@(currentSubscription.Plan.MaxLeadsPerMonth == -1 ? "Unlimited" : currentSubscription.Plan.MaxLeadsPerMonth.ToString()) leads/month</li>
                                </ul>
                            </div>
                        }
                        else
                        {
                            <div class="usage-stats">
                                <div class="usage-item">
                                    <span class="usage-label">Agents Used</span>
                                    <span class="usage-value">@currentSubscription.CurrentAgentCount / @(currentSubscription.Plan.MaxAgents == -1 ? "∞" : currentSubscription.Plan.MaxAgents.ToString())</span>
                                </div>
                                @if (currentSubscription.Plan.MaxAgents > 0)
                                {
                                    <div class="usage-bar">
                                        <div class="usage-fill" style="width: @(Math.Min(100, (currentSubscription.CurrentAgentCount * 100.0 / currentSubscription.Plan.MaxAgents)))%"></div>
                                    </div>
                                }
                                
                                <div class="usage-item mt-3">
                                    <span class="usage-label">Monthly Leads</span>
                                    <span class="usage-value">@currentSubscription.CurrentMonthLeads / @(currentSubscription.Plan.MaxLeadsPerMonth == -1 ? "∞" : currentSubscription.Plan.MaxLeadsPerMonth.ToString())</span>
                                </div>
                                @if (currentSubscription.Plan.MaxLeadsPerMonth > 0)
                                {
                                    <div class="usage-bar">
                                        <div class="usage-fill" style="width: @(Math.Min(100, (currentSubscription.CurrentMonthLeads * 100.0 / currentSubscription.Plan.MaxLeadsPerMonth)))%"></div>
                                    </div>
                                }
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Scheduled Subscription Alert -->
    @if (scheduledSubscription != null)
    {
        <div class="alert alert-info d-flex align-items-center mb-4" style="border-radius: 12px; border-left: 4px solid #3b82f6; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
            <i class="fa-solid fa-calendar-check me-3" style="font-size: 2rem; color: #3b82f6;"></i>
            <div class="flex-grow-1">
                <h5 class="mb-1" style="color: #1e40af; font-weight: 700;">
                    <i class="fa-solid fa-clock me-2"></i>Upgrade Scheduled
                </h5>
                <p class="mb-0" style="color: #1e3a8a;">
                    Your <strong>@scheduledSubscription.Plan?.PlanName</strong> plan is scheduled to activate on 
                    <strong>@scheduledSubscription.StartDate.ToString("MMMM dd, yyyy")</strong>
                    (when your current plan expires). Payment of <strong>₹@scheduledSubscription.Amount.ToString("N0")</strong> has already been received.
                </p>
            </div>
            @if (currentSubscription != null)
            {
                <button type="button" class="btn btn-sm btn-outline-primary ms-3" onclick="showScheduledPlanDetails()">
                    View Details
                </button>
            }
        </div>
    }

    <!-- Plan Selection -->
    <div class="mb-4">
        <h2 class="text-center mb-4" style="font-weight: 700; color: #1e293b;">Choose Your Perfect Plan</h2>
        
        <!-- Billing Toggle -->
        <div class="pricing-toggle">
            <button type="button" id="monthlyBtn" class="active" onclick="toggleBilling('monthly')">Monthly</button>
            <button type="button" id="annualBtn" onclick="toggleBilling('annual')">Annual</button>
        </div>
    </div>

    <!-- Plans Comparison -->
    <div class="plan-comparison">
        @if (availablePlans != null)
        {
            @foreach (var plan in availablePlans)
            {
                var currentBillingCycle = currentSubscription?.BillingCycle?.ToLower() ?? "monthly";
                var isCurrent = currentSubscription?.PlanId == plan.PlanId;
                var isScheduled = scheduledSubscription?.PlanId == plan.PlanId;
                var isRecommended = plan.PlanType.ToLower() == "standard";
                
                // Check if this plan has a pending refund
                var hasPendingRefund = cancelledWithPendingRefund?.Any(c => c.PlanId == plan.PlanId) ?? false;
                var cancelledPlan = cancelledWithPendingRefund?.FirstOrDefault(c => c.PlanId == plan.PlanId);
                
                <div class="plan-card @(isCurrent ? "current" : "") @(isScheduled ? "scheduled" : "") @(hasPendingRefund ? "refund-pending" : "") @(isRecommended && !isCurrent && !isScheduled && !hasPendingRefund ? "recommended" : "")" data-plan-id="@plan.PlanId">
                    <div class="plan-header">
                        <h3 class="plan-name">@plan.PlanName</h3>
                        @if (!string.IsNullOrEmpty(plan.Description))
                        {
                            <p class="plan-description">@plan.Description</p>
                        }
                    </div>

                    <div class="plan-pricing">
                        <div class="price-display">
                            <div class="monthly-price">
                                <span class="price-currency">₹</span><span class="price-amount">@plan.MonthlyPrice.ToString("N0")</span>
                                <div class="price-period">per month</div>
                            </div>
                            <div class="annual-price" style="display: none;">
                                <span class="price-currency">₹</span><span class="price-amount">@plan.YearlyPrice.ToString("N0")</span>
                                <div class="price-period">per year</div>
                                @{
                                    var monthlySavings = (plan.MonthlyPrice * 12) - plan.YearlyPrice;
                                    var savingsPercent = plan.MonthlyPrice > 0 ? Math.Round((monthlySavings / (plan.MonthlyPrice * 12)) * 100) : 0;
                                }
                                @if (monthlySavings > 0 && plan.MonthlyPrice > 0)
                                {
                                    <div class="price-savings">Save @savingsPercent% (₹@monthlySavings.ToString("N0"))</div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="plan-features">
                        <div class="feature-category">
                            <h6>Limits</h6>
                            <div class="feature-item">
                                <div class="feature-icon @(plan.MaxAgents == -1 ? "feature-enabled" : "feature-limited")">
                                    <i class="fa-solid fa-@(plan.MaxAgents == -1 ? "check" : "users")"></i>
                                </div>
                                <span>@(plan.MaxAgents == -1 ? "Unlimited" : plan.MaxAgents.ToString()) Agents</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon @(plan.MaxLeadsPerMonth == -1 ? "feature-enabled" : "feature-limited")">
                                    <i class="fa-solid fa-@(plan.MaxLeadsPerMonth == -1 ? "check" : "chart-line")"></i>
                                </div>
                                <span>@(plan.MaxLeadsPerMonth == -1 ? "Unlimited" : plan.MaxLeadsPerMonth.ToString()) Leads/Month</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon @(plan.MaxStorageGB == -1 ? "feature-enabled" : "feature-limited")">
                                    <i class="fa-solid fa-@(plan.MaxStorageGB == -1 ? "check" : "database")"></i>
                                </div>
                                <span>@(plan.MaxStorageGB == -1 ? "Unlimited" : plan.MaxStorageGB.ToString() + " GB") Storage</span>
                            </div>
                        </div>

                        <div class="feature-category">
                            <h6>Integrations</h6>
                            <div class="feature-item">
                                <div class="feature-icon @(plan.HasWhatsAppIntegration ? "feature-enabled" : "feature-disabled")">
                                    <i class="fa-solid fa-@(plan.HasWhatsAppIntegration ? "check" : "times")"></i>
                                </div>
                                <span>WhatsApp Integration</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon @(plan.HasFacebookIntegration ? "feature-enabled" : "feature-disabled")">
                                    <i class="fa-solid fa-@(plan.HasFacebookIntegration ? "check" : "times")"></i>
                                </div>
                                <span>Facebook Integration</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon @(plan.HasEmailIntegration ? "feature-enabled" : "feature-disabled")">
                                    <i class="fa-solid fa-@(plan.HasEmailIntegration ? "check" : "times")"></i>
                                </div>
                                <span>Email Integration</span>
                            </div>
                        </div>

                        <div class="feature-category">
                            <h6>Reports & Support</h6>
                            <div class="feature-item">
                                <div class="feature-icon @(plan.HasAdvancedReports ? "feature-enabled" : "feature-disabled")">
                                    <i class="fa-solid fa-@(plan.HasAdvancedReports ? "check" : "times")"></i>
                                </div>
                                <span>Advanced Reports</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon @(plan.HasDataExport ? "feature-enabled" : "feature-disabled")">
                                    <i class="fa-solid fa-@(plan.HasDataExport ? "check" : "times")"></i>
                                </div>
                                <span>Data Export</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon feature-enabled">
                                    <i class="fa-solid fa-headset"></i>
                                </div>
                                <span>@plan.SupportLevel Support</span>
                            </div>
                        </div>
                    </div>

                    <div class="plan-action">
                        @if (hasPendingRefund)
                        {
                            <div class="alert alert-warning mb-3" style="margin-top: 0;">
                                <i class="fa-solid fa-clock me-2"></i>
                                <strong>Refund Processing</strong><br />
                                Your refund of ₹@cancelledPlan?.Amount.ToString("N0") is being processed.<br />
                                <small>Expected within 5-7 business days</small>
                            </div>
                            <button class="btn-select-plan" disabled style="background: #6c757d; cursor: not-allowed; color: wheat;">
                                <i class="fa-solid fa-headset me-2"></i>Support Contact
                            </button>
                        }
                        else if (isCurrent)
                        {
                            <button class="btn-select-plan btn-current" disabled>
                                <i class="fa-solid fa-crown me-2"></i>Current Plan
                            </button>
                            <button class="btn-select-plan btn-upgrade mt-2" style="display: none;" 
                                    data-plan-id="@plan.PlanId" data-plan-name="@plan.PlanName" 
                                    data-monthly="@plan.MonthlyPrice" data-yearly="@plan.YearlyPrice"
                                    onclick="selectPlan(@plan.PlanId, '@plan.PlanName', @plan.MonthlyPrice, @plan.YearlyPrice)">
                                <i class="fa-solid fa-arrow-up me-2"></i>Switch Billing
                            </button>
                        }
                        else if (isScheduled)
                        {
                            <div class="text-center mb-2" style="color: #3b82f6; font-weight: 600;">
                                <i class="fa-solid fa-calendar-check me-1"></i>
                                Scheduled for @scheduledSubscription?.StartDate.ToString("MMMM dd, yyyy")
                            </div>
                            <button class="btn-select-plan btn-danger" style="font-size: 0.85rem; white-space: nowrap;" 
                                    onclick="cancelScheduledPlan(@scheduledSubscription?.SubscriptionId, '@scheduledSubscription?.Plan?.PlanName', @scheduledSubscription?.Amount)">
                                <i class="fa-solid fa-times-circle me-2"></i>Cancel Scheduled Plan
                            </button>
                        }
                        else
                        {
                            var isUpgrade = currentSubscription?.Plan != null && plan.MonthlyPrice > currentSubscription.Plan.MonthlyPrice;
                            <button class="btn-select-plan @(isUpgrade ? "btn-upgrade" : "btn-downgrade")" 
                                    onclick="selectPlan(@plan.PlanId, '@plan.PlanName', @plan.MonthlyPrice, @plan.YearlyPrice)">
                                <i class="fa-solid fa-@(isUpgrade ? "arrow-up" : "arrow-down") me-2"></i>
                                @(isUpgrade ? "Upgrade" : "Select") Plan
                            </button>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="paymentModalLabel">Confirm Plan Selection</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h4 id="selectedPlanName"></h4>
                    <div class="h2 text-primary" id="selectedPlanPrice"></div>
                    <div class="text-muted" id="selectedBillingCycle"></div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    Your subscription will be activated immediately after successful payment.
                </div>
                
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary btn-lg" id="proceedToPayment">
                        <i class="fa-solid fa-credit-card me-2"></i>Proceed to Payment
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let selectedPlanId = null;
        let selectedBillingCycle = 'monthly';
        
        // Initialize with current subscription's billing cycle
        document.addEventListener('DOMContentLoaded', function() {
            const currentBilling = '@(currentSubscription?.BillingCycle?.ToLower() ?? "monthly")';
            toggleBilling(currentBilling);
        });
        
        function toggleBilling(cycle) {
            selectedBillingCycle = cycle;
            
            // Update button states
            document.getElementById('monthlyBtn').classList.toggle('active', cycle === 'monthly');
            document.getElementById('annualBtn').classList.toggle('active', cycle === 'annual');
            
            // Show/hide pricing
            document.querySelectorAll('.monthly-price').forEach(el => {
                el.style.display = cycle === 'monthly' ? 'block' : 'none';
            });
            document.querySelectorAll('.annual-price').forEach(el => {
                el.style.display = cycle === 'annual' ? 'block' : 'none';
            });
            
            // Update current plan buttons and styling
            updateCurrentPlanButtons(cycle);
        }
        
        function updateCurrentPlanButtons(cycle) {
            const currentBilling = '@(currentSubscription?.BillingCycle?.ToLower() ?? "")';
            const currentPlanId = '@(currentSubscription?.PlanId ?? 0)';
            
            document.querySelectorAll('.plan-card').forEach(card => {
                const planId = card.getAttribute('data-plan-id');
                const currentBtn = card.querySelector('.btn-current');
                const switchBtn = card.querySelector('[data-plan-id]');
                
                // Remove current class from all cards first
                card.classList.remove('current');
                
                // Add current class only to the card that matches both plan and billing cycle
                if (planId == currentPlanId && currentBilling === cycle) {
                    card.classList.add('current');
                }
                
                if (currentBtn && switchBtn && planId == currentPlanId) {
                    // If this is current plan but different billing cycle, show switch button
                    if (currentBilling !== cycle) {
                        currentBtn.style.display = 'none';
                        switchBtn.style.display = 'block';
                        switchBtn.innerHTML = `<i class="fa-solid fa-arrow-up me-2"></i>Switch to ${cycle === 'annual' ? 'Annual' : 'Monthly'}`;
                    } else {
                        currentBtn.style.display = 'block';
                        switchBtn.style.display = 'none';
                    }
                }
            });
        }
        
        function selectPlan(planId, planName, monthlyPrice, yearlyPrice) {
            selectedPlanId = planId;
            
            const price = selectedBillingCycle === 'annual' ? yearlyPrice : monthlyPrice;
            const period = selectedBillingCycle === 'annual' ? 'per year' : 'per month';
            
            document.getElementById('selectedPlanName').textContent = planName;
            document.getElementById('selectedPlanPrice').textContent = '₹' + price.toLocaleString();
            document.getElementById('selectedBillingCycle').textContent = period;
            
            // Update modal content based on whether user has current subscription
            const currentPlanExpiry = '@(currentSubscription?.EndDate.ToString("MMMM dd, yyyy") ?? "")';
            const hasCurrentPlan = currentPlanExpiry !== '';
            
            const alertDiv = document.querySelector('.alert-info');
            if (hasCurrentPlan) {
                // Show scheduled activation message
                const nextDay = new Date('@(currentSubscription?.EndDate.ToString("yyyy-MM-dd") ?? "")');
                nextDay.setDate(nextDay.getDate() + 1);
                const activationDate = nextDay.toLocaleDateString('en-GB', { 
                    day: '2-digit', 
                    month: 'long', 
                    year: 'numeric' 
                });
                
                alertDiv.innerHTML = `
                    <i class="fa-solid fa-calendar-alt me-2"></i>
                    <strong>Scheduled Upgrade:</strong><br>
                    Your current plan expires on <strong>${currentPlanExpiry}</strong>.<br>
                    This new plan will be activated on <strong>${activationDate}</strong>.
                `;
                alertDiv.className = 'alert alert-warning';
            } else {
                // Show immediate activation message
                alertDiv.innerHTML = `
                    <i class="fa-solid fa-info-circle me-2"></i>
                    Your subscription will be activated immediately after successful payment.
                `;
                alertDiv.className = 'alert alert-info';
            }
            
            new bootstrap.Modal(document.getElementById('paymentModal')).show();
        }
        
        document.getElementById('proceedToPayment').addEventListener('click', function() {
            if (!selectedPlanId) return;
            
            // Prevent duplicate clicks
            const btn = this;
            if (btn.disabled) return;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            // For testing - bypass Razorpay if using dummy keys
            const testKey = '@razorpayKeyId';
            if (testKey.includes('abcdefghijklmnop')) {
                // Simulate successful payment for testing
                setTimeout(() => {
                    confirmPayment('pay_test_123', 'order_test_123', 'test_signature');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-lock me-2"></i>Proceed to Payment';
                }, 1000);
                bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                return;
            }
            
            // First, create order on server
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            fetch('/Subscription/SelectPlan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'RequestVerificationToken': token
                },
                body: `planId=${selectedPlanId}&billingCycle=${selectedBillingCycle}&__RequestVerificationToken=${encodeURIComponent(token)}`
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-lock me-2"></i>Proceed to Payment';
                
                if (data.success) {
                    // Show different confirmation based on whether it's scheduled
                    if (data.isScheduled) {
                        // Show SweetAlert for scheduled subscription
                        let title = 'Schedule Plan for Future Activation?';
                        let message = `Your current plan expires on @(currentSubscription?.EndDate.ToString("MMMM dd, yyyy") ?? ""). The ${data.planName} plan will be activated on ${data.startDate}.`;
                        let paymentInfo = '';
                        
                        if (data.hasExistingScheduled) {
                            title = 'Replace Scheduled Plan?';
                            message = `You have ${data.existingPlanName || 'a plan'} already scheduled. This will replace it with ${data.planName}.`;
                            
                            if (data.creditAmount > 0) {
                                paymentInfo = `<div class="alert alert-success mt-2 mb-2" style="text-align: left;">
                                    <i class="fa-solid fa-tag"></i> <strong>Credit Applied!</strong><br>
                                    Plan Price: <span style="text-decoration: line-through;">₹${data.fullAmount}</span><br>
                                    Credit from ${data.existingPlanName}: <strong class="text-success">-₹${data.creditAmount}</strong><br>
                                    <strong>You Pay: ₹${data.amountToPay}</strong>
                                </div>`;
                            }
                        }
                        
                        Swal.fire({
                            title: title,
                            html: `<div style="text-align: left;">
                                     <p><i class="fa-solid fa-calendar-check text-primary"></i> <strong>Current Plan:</strong> Expires @(currentSubscription?.EndDate.ToString("MMMM dd, yyyy") ?? "")</p>
                                     <p><i class="fa-solid fa-rocket text-success"></i> <strong>New Plan:</strong> ${data.planName} activates on ${data.startDate}</p>
                                     ${paymentInfo}
                                     <p><i class="fa-solid fa-info-circle text-info"></i> You'll continue using your current plan until it expires.</p>
                                   </div>`,
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#3b82f6',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: data.creditAmount > 0 ? `Yes, Pay ₹${data.amountToPay}` : 'Yes, Schedule It!',
                            cancelButtonText: 'Cancel',
                            width: '550px'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                proceedWithPayment(data);
                            }
                        });
                    } else {
                        // Immediate subscription - proceed directly
                        proceedWithPayment(data);
                    }
                } else {
                    // Check if it's the same plan scenario
                    if (data.isSamePlan) {
                        Swal.fire({
                            title: 'Plan Already Scheduled',
                            html: `<div style="text-align: left;">
                                     <div class="alert alert-info mb-3">
                                         <i class="fa-solid fa-info-circle"></i> <strong>Current Status:</strong><br>
                                         You already have <strong>${data.existingPlanName}</strong> scheduled for activation on <strong>${data.scheduledDate}</strong>
                                     </div>
                                     <p><i class="fa-solid fa-question-circle text-primary"></i> <strong>What would you like to do?</strong></p>
                                     <ul class="text-start">
                                         <li><strong>Keep it:</strong> Your plan will activate as scheduled</li>
                                         <li><strong>Cancel it:</strong> Remove the scheduled plan and request a refund</li>
                                     </ul>
                                   </div>`,
                            icon: 'info',
                            showCancelButton: true,
                            showDenyButton: true,
                            confirmButtonColor: '#ef4444',
                            denyButtonColor: '#6c757d',
                            cancelButtonColor: '#3b82f6',
                            confirmButtonText: '<i class="fa-solid fa-times-circle"></i> Cancel Scheduled Plan',
                            denyButtonText: '<i class="fa-solid fa-check"></i> Keep It',
                            cancelButtonText: 'Close',
                            width: '550px'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // User wants to cancel the scheduled plan
                                cancelScheduledPlan(data.subscriptionId, data.existingPlanName, data.existingAmount);
                            }
                        });
                    }
                    // Check if it's a downgrade scenario
                    else if (data.isDowngrade) {
                        Swal.fire({
                            title: 'Downgrade Not Available',
                            html: `<div style="text-align: left;">
                                     <p><i class="fa-solid fa-exclamation-triangle text-warning"></i> ${data.message}</p>
                                     <div class="alert alert-info mt-3">
                                         <i class="fa-solid fa-info-circle"></i> <strong>Why?</strong><br>
                                         You've already paid for a higher-tier plan. To switch to a lower-tier plan and receive a refund, 
                                         please contact our support team who will assist you with the process.
                                     </div>
                                   </div>`,
                            icon: 'warning',
                            confirmButtonColor: '#3b82f6',
                            confirmButtonText: 'Contact Support',
                            showCancelButton: true,
                            cancelButtonText: 'Close'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Redirect to support or open email
                                window.location.href = '/Home/Contact'; // Adjust to your support page
                            }
                        });
                    } else {
                        showToast(data.message || 'Failed to create payment order', 'error');
                    }
                }
            })
            .catch(error => {
                console.error('SelectPlan error:', error);
                showToast('An error occurred. Please try again.', 'error');
                // Re-enable button on error
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-lock me-2"></i>Proceed to Payment';
            });
        });
        
        function proceedWithPayment(data) {
            // Initialize Razorpay
            const options = {
                key: '@razorpayKeyId',
                amount: data.amount,
                currency: 'INR',
                name: 'CRM Subscription',
                description: `${data.planName} - ${selectedBillingCycle}`,
                order_id: data.orderId,
                handler: function(response) {
                    // Payment successful, confirm on server
                    confirmPayment(response.razorpay_payment_id, response.razorpay_order_id, response.razorpay_signature);
                },
                prefill: {
                    name: 'Partner Name',
                    email: 'partner@example.com'
                },
                theme: {
                    color: '#3b82f6'
                }
            };
            
            const rzp = new Razorpay(options);
            rzp.open();
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
        }
        
        function confirmPayment(paymentId, orderId, signature) {
            // Show loading indicator
            Swal.fire({
                title: 'Processing Payment...',
                html: '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Please wait while we confirm your payment.</p></div>',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false
            });
            
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            fetch('/Subscription/ConfirmPayment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'RequestVerificationToken': token
                },
                body: `razorpayPaymentId=${paymentId}&razorpayOrderId=${orderId}&razorpaySignature=${signature}&planId=${selectedPlanId}&billingCycle=${selectedBillingCycle}&__RequestVerificationToken=${encodeURIComponent(token)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: '✅ Payment Successful!',
                        html: `<div style="text-align: left; padding: 20px;">
                                 <div class="text-center mb-4">
                                     <i class="fa-solid fa-check-circle text-success" style="font-size: 4rem;"></i>
                                     <h5 class="mt-3">Subscription Activated</h5>
                                 </div>
                                 <div class="alert alert-success mb-3">
                                     <strong><i class="fa-solid fa-crown me-2"></i>Welcome to ${data.planName || 'Your New Plan'}!</strong>
                                 </div>
                                 <div class="card mb-3" style="background: #f8f9fa; border: none;">
                                     <div class="card-body">
                                         <h6 class="mb-3">Payment Details:</h6>
                                         <div style="font-size: 0.9rem; line-height: 1.8;">
                                             <strong>Order ID:</strong> ${data.orderId || orderId}<br>
                                             <strong>Payment ID:</strong> ${paymentId}<br>
                                             ${data.planName ? '<strong>Plan:</strong> ' + data.planName + '<br>' : ''}
                                             ${data.billingCycle ? '<strong>Billing:</strong> ' + data.billingCycle + '<br>' : ''}
                                             ${data.nextBillingDate ? '<strong>Next Billing:</strong> ' + new Date(data.nextBillingDate).toLocaleDateString('en-IN', { year: 'numeric', month: 'long', day: 'numeric' }) + '<br>' : ''}
                                             ${data.amount ? '<strong>Amount Paid:</strong> <span class="text-success">₹' + data.amount.toLocaleString('en-IN') + '</span>' : ''}
                                         </div>
                                     </div>
                                 </div>
                                 <div class="alert alert-info mb-0">
                                     <i class="fa-solid fa-info-circle me-2"></i>
                                     <small>A confirmation email has been sent. You can download your invoice from the Billing section.</small>
                                 </div>
                               </div>`,
                        icon: 'success',
                        confirmButtonColor: '#10b981',
                        confirmButtonText: '<i class="fa-solid fa-eye me-2"></i>View My Subscription',
                        showCancelButton: true,
                        cancelButtonText: '<i class="fa-solid fa-receipt me-2"></i>View Transactions',
                        cancelButtonColor: '#6c757d',
                        allowOutsideClick: false,
                        timer: 12000,
                        timerProgressBar: true,
                        customClass: {
                            popup: 'swal-wide'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.location.href = '/Subscription/MyPlan';
                        } else {
                            window.location.href = '/Subscription/Transactions';
                        }
                    });
                } else {
                    // Close loading
                    Swal.close();
                    
                    // Check error type
                    if (data.errorCode === 'PAYMENT_FAILED') {
                        Swal.fire({
                            title: '❌ Payment Failed',
                            html: `<div style="text-align: left;">
                                     <div class="alert alert-danger">
                                         <i class="fa-solid fa-times-circle"></i> ${data.message}
                                     </div>
                                     ${data.canRetry ? '<p><i class="fa-solid fa-redo"></i> You can try again with a different payment method.</p>' : ''}
                                   </div>`,
                            icon: 'error',
                            confirmButtonText: data.canRetry ? 'Try Again' : 'OK',
                            showCancelButton: data.canRetry,
                            cancelButtonText: 'Cancel'
                        }).then((result) => {
                            if (result.isConfirmed && data.canRetry) {
                                location.reload();
                            }
                        });
                    } else if (data.errorCode === 'VERIFICATION_FAILED') {
                        Swal.fire({
                            title: '⚠️ Verification Failed',
                            html: `<div style="text-align: left;">
                                     <div class="alert alert-warning">
                                         <i class="fa-solid fa-exclamation-triangle"></i> ${data.message}
                                     </div>
                                     <p><small>If you have any concerns, please contact support with order ID: ${orderId}</small></p>
                                   </div>`,
                            icon: 'warning',
                            confirmButtonText: 'Contact Support'
                        });
                    } else if (data.isDowngrade) {
                        Swal.fire({
                            title: '⚠️ Downgrade Not Allowed',
                            html: `<div style="text-align: left;">
                                     <div class="alert alert-warning mb-3">
                                         <strong><i class="fa-solid fa-info-circle"></i> Current Situation:</strong><br>
                                         You have <strong>${data.existingPlanName}</strong> scheduled (₹${data.existingAmount})
                                     </div>
                                     <div class="alert alert-danger mb-3">
                                         <strong><i class="fa-solid fa-exclamation-triangle"></i> Attempted Change:</strong><br>
                                         Switch to <strong>${data.newPlanName}</strong> (₹${data.newAmount})<br>
                                         <span class="text-success">Potential Refund: ₹${data.refundAmount}</span>
                                     </div>
                                     <div class="alert alert-info">
                                         <strong><i class="fa-solid fa-lightbulb"></i> What to do?</strong><br>
                                         Downgrades require manual processing for refunds. Please contact our support team who will:
                                         <ul class="mt-2 mb-0">
                                             <li>Process your refund of ₹${data.refundAmount}</li>
                                             <li>Switch you to ${data.newPlanName}</li>
                                             <li>Maintain the same activation date</li>
                                         </ul>
                                     </div>
                                   </div>`,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#3b82f6',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: '<i class="fa-solid fa-headset"></i> Contact Support',
                            cancelButtonText: 'Close',
                            width: '600px'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // Redirect to support page or open email
                                window.location.href = '/Home/Contact'; // Adjust to your support page URL
                            }
                        });
                    } else {
                        // Other errors - show as SweetAlert too
                        Swal.fire({
                            title: 'Payment Failed',
                            text: data.message || 'Payment verification failed. Please try again or contact support.',
                            icon: 'error',
                            confirmButtonColor: '#ef4444',
                            confirmButtonText: 'Close'
                        });
                    }
                }
            })
            .catch(error => {
                console.error('ConfirmPayment error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Payment verification failed. Please contact support with your payment details.',
                    icon: 'error',
                    confirmButtonColor: '#ef4444',
                    confirmButtonText: 'Close'
                });
            });
        }
        
        function showToast(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        function showScheduledPlanDetails() {
            @if (scheduledSubscription != null)
            {
                <text>
                const details = `
                    <div class="p-3">
                        <h5 class="mb-3"><i class="fa-solid fa-calendar-check me-2"></i>Scheduled Plan Details</h5>
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">Plan:</th>
                                <td><strong>@scheduledSubscription.Plan?.PlanName</strong></td>
                            </tr>
                            <tr>
                                <th>Billing Cycle:</th>
                                <td>@scheduledSubscription.BillingCycle</td>
                            </tr>
                            <tr>
                                <th>Amount Paid:</th>
                                <td><strong>₹@scheduledSubscription.Amount.ToString("N0")</strong></td>
                            </tr>
                            <tr>
                                <th>Activation Date:</th>
                                <td><strong>@scheduledSubscription.StartDate.ToString("MMMM dd, yyyy")</strong></td>
                            </tr>
                            <tr>
                                <th>Valid Until:</th>
                                <td>@scheduledSubscription.EndDate.ToString("MMMM dd, yyyy")</td>
                            </tr>
                            <tr>
                                <th>Payment Date:</th>
                                <td>@(scheduledSubscription.LastPaymentDate?.ToString("MMMM dd, yyyy") ?? scheduledSubscription.CreatedOn.ToString("MMMM dd, yyyy"))</td>
                            </tr>
                        </table>
                        <div class="alert alert-info mt-3">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            This plan will automatically activate when your current plan expires.
                        </div>
                    </div>
                `;
                
                const modalHtml = `
                    <div class="modal fade" id="scheduledPlanModal" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Scheduled Plan</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    ${details}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = new bootstrap.Modal(document.getElementById('scheduledPlanModal'));
                modal.show();
                
                document.getElementById('scheduledPlanModal').addEventListener('hidden.bs.modal', function () {
                    this.remove();
                });
                </text>
            }
        }

        function cancelScheduledPlan(subscriptionId, planName, amount) {
            Swal.fire({
                title: 'Cancel Scheduled Plan?',
                html: `<div style="text-align: left;">
                         <p><i class="fa-solid fa-exclamation-triangle text-warning"></i> Are you sure you want to cancel your scheduled <strong>${planName}</strong> plan?</p>
                         <div class="alert alert-warning mt-3">
                             <strong><i class="fa-solid fa-info-circle"></i> Important:</strong><br>
                             • Your current plan will continue as normal<br>
                             • The scheduled upgrade will be cancelled<br>
                             • Amount paid: ₹${amount}<br>
                             • You'll need to contact support for a refund
                         </div>
                       </div>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Yes, Cancel It',
                cancelButtonText: 'Keep Scheduled Plan'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Proceed with cancellation
                    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                    
                    fetch('/Subscription/CancelScheduledPlan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'RequestVerificationToken': token
                        },
                        body: `subscriptionId=${subscriptionId}&__RequestVerificationToken=${encodeURIComponent(token)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: 'Cancelled Successfully',
                                html: `<div style="text-align: center;">
                                         <i class="fa-solid fa-check-circle text-success" style="font-size: 4rem;"></i>
                                         <p class="mt-3 mb-3">${data.message}</p>
                                         ${data.refundPending ? `
                                         <div class="alert alert-warning">
                                             <i class="fa-solid fa-clock"></i> <strong>Refund Status: Pending</strong><br>
                                             Amount: ₹${data.refundAmount}<br>
                                             <small>Our support team will process your refund within 5-7 business days. 
                                             You will receive an email notification once processed.</small>
                                         </div>
                                         <p class="text-muted">
                                             <i class="fa-solid fa-headset"></i> Need help? 
                                             <a href="/Home/Contact" class="text-primary">Contact Support</a>
                                         </p>
                                         ` : ''}
                                       </div>`,
                                icon: 'success',
                                confirmButtonColor: '#10b981',
                                confirmButtonText: 'OK',
                                width: '550px'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                title: 'Cancellation Failed',
                                text: data.message,
                                icon: 'error',
                                confirmButtonColor: '#ef4444'
                            });
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Error',
                            text: 'Failed to cancel scheduled plan. Please try again or contact support.',
                            icon: 'error',
                            confirmButtonColor: '#ef4444'
                        });
                    });
                }
            });
        }
    </script>
}