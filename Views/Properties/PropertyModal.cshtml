<div class="modal fade" id="addPropertyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 700px !important; width: 700px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add New Property</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="propertyForm" novalidate>
                <div class="modal-body">
                    <input type="hidden" id="propertyId" value="0">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Property Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="propertyName" required>
                            <div class="invalid-feedback">Please enter property name</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Builder <span class="text-danger">*</span></label>
                            <select class="form-select" id="builderId" required>
                                <option value="">Select Builder</option>
                                @if (ViewBag.Builders != null)
                                {
                                    foreach (var builder in ViewBag.Builders)
                                    {
                                        <option value="@builder.BuilderId">@builder.BuilderName</option>
                                    }
                                }
                            </select>
                            <div class="invalid-feedback">Please select a builder</div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="location">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Area (Sqft)</label>
                            <input type="number" step="0.01" class="form-control" id="areaSqft">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control" id="price">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Purchase Type</label>
                            <select class="form-select" id="purchaseType">
                                <option value="">Select Purchase Type</option>
                                <option value="Sale">Sale</option>
                                <option value="Rent">Rent</option>
                                <option value="Lease">Lease</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Property Image</label>
                            <input type="file" class="form-control" id="propertyImage" accept="image/*" onchange="previewPropertyImage(this)">
                            <div id="imagePreviewContainer" class="mt-2" style="display: none;">
                                <img id="imagePreview" src="" alt="Preview" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 1px solid #ddd;">
                                <div class="mt-1">
                                    <small class="text-muted">Current/Selected Image</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Assigned To (Sales Person)</label>
                            <select class="form-select" id="assignedTo">
                                <option value="">Select Sales Person</option>
                                @if (ViewBag.Executives != null)
                                {
                                    foreach (var exec in ViewBag.Executives)
                                    {
                                        <option value="@exec.UserId">@exec.Username</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="savePropertyBtn">
                        <span class="spinner-border spinner-border-sm d-none" id="saveSpinner"></span>
                        Save Property
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const propertyForm = document.getElementById('propertyForm');
        const addPropertyModal = document.getElementById('addPropertyModal');

        // Form submission
        if (propertyForm) {
            propertyForm.addEventListener('submit', function(e) {
                e.preventDefault();
                e.stopPropagation();

                if (!propertyForm.checkValidity()) {
                    propertyForm.classList.add('was-validated');
                    return;
                }

                saveProperty();
            });
        }

        // Reset form when modal is closed
        if (addPropertyModal) {
            addPropertyModal.addEventListener('hidden.bs.modal', function() {
                resetPropertyForm();
            });
        }
    });

    function saveProperty() {
        const form = document.getElementById('propertyForm');
        const saveBtn = document.getElementById('savePropertyBtn');
        const spinner = document.getElementById('saveSpinner');

        // Disable button and show spinner
        saveBtn.disabled = true;
        spinner.classList.remove('d-none');

        const formData = new FormData();
        formData.append('propertyId', document.getElementById('propertyId').value);
        formData.append('propertyName', document.getElementById('propertyName').value);
        formData.append('builderId', document.getElementById('builderId').value);
        formData.append('location', document.getElementById('location').value || '');
        formData.append('areaSqft', document.getElementById('areaSqft').value || '');
        formData.append('price', document.getElementById('price').value || '');
        formData.append('purchaseType', document.getElementById('purchaseType').value || '');
        formData.append('assignedTo', document.getElementById('assignedTo').value || '');

        // Add anti-forgery token
        const token = document.querySelector('input[name="__RequestVerificationToken"]');
        if (token) {
            formData.append('__RequestVerificationToken', token.value);
        }

        const imageFile = document.getElementById('propertyImage').files[0];
        if (imageFile) {
            formData.append('propertyImage', imageFile);
        }

        fetch('/Properties/SaveProperty', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            saveBtn.disabled = false;
            spinner.classList.add('d-none');

            if (data.success) {
                showToast(data.message || 'Property saved successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addPropertyModal')).hide();
                resetPropertyForm();
                
                // Dispatch event to reload properties
                window.dispatchEvent(new Event('property-saved'));
            } else {
                showToast(data.message || 'Error saving property', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            saveBtn.disabled = false;
            spinner.classList.add('d-none');
            showToast('Error saving property', 'error');
        });
    }

    function resetPropertyForm() {
        const form = document.getElementById('propertyForm');
        if (form) {
            form.reset();
            form.classList.remove('was-validated');
            document.getElementById('propertyId').value = '0';
            document.getElementById('modalTitle').textContent = 'Add New Property';
            
            // Hide image preview
            document.getElementById('imagePreviewContainer').style.display = 'none';
        }
    }

    // Function to preview image when file is selected
    function previewPropertyImage(input) {
        const preview = document.getElementById('imagePreview');
        const container = document.getElementById('imagePreviewContainer');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                container.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Function to populate modal for editing (called from Index.cshtml)
    window.populatePropertyModal = function(data) {
        document.getElementById('modalTitle').textContent = 'Edit Property';
        document.getElementById('propertyId').value = data.propertyId;
        document.getElementById('propertyName').value = data.propertyName || '';
        document.getElementById('builderId').value = data.builderId || '';
        document.getElementById('location').value = data.location || '';
        document.getElementById('areaSqft').value = data.areaSqft || '';
        document.getElementById('price').value = data.price || '';
        document.getElementById('purchaseType').value = data.purchaseType || '';
        document.getElementById('assignedTo').value = data.assignedTo || '';
        
        // Show existing image if available
        if (data.propertyImage && data.propertyImage.length > 0) {
            try {
                const bytes = new Uint8Array(data.propertyImage);
                let binary = '';
                for (let i = 0; i < bytes.length; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                const base64 = btoa(binary);
                const preview = document.getElementById('imagePreview');
                const container = document.getElementById('imagePreviewContainer');
                preview.src = 'data:image/jpeg;base64,' + base64;
                container.style.display = 'block';
            } catch (e) {
                console.error('Error displaying image:', e);
            }
        }
    };

    function showToast(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            <i data-feather="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
        
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>
